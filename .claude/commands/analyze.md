---
description: Полный анализ приложения Govorilka — безопасность, архитектура, тесты, качество кода
argument-hint: [область] security|architecture|tests|quality|macos|all
---

# Команда: Полный анализ Govorilka

Ты выполняешь комплексный анализ macOS-приложения Govorilka. Это приложение для голосового ввода текста через API Deepgram.

## Аргумент команды

Пользователь указал область: `$ARGUMENTS`

Если область не указана или указано `all`, выполни ВСЕ фазы анализа ниже.
Если указана конкретная область (`security`, `architecture`, `tests`, `quality`, `macos`), выполни только соответствующую фазу.

---

## Фаза 1: Безопасность (security)

Проверь следующие аспекты безопасности:

### 1.1 Хранение секретов
- Найди где хранится API ключ Deepgram (поиск: `apiKey`, `UserDefaults`, `Keychain`)
- **CRITICAL**: Если ключ в UserDefaults — это уязвимость, любой процесс может прочитать
- Рекомендация: миграция в Keychain через Security framework

### 1.2 Сетевая безопасность
- WebSocket соединение должно использовать `wss://` (не `ws://`)
- Проверь наличие certificate pinning
- Проверь как обрабатываются сетевые ошибки

### 1.3 Данные пользователя
- Как хранятся транскрипции (история)?
- Скриншоты (Pro режим) — шифруются ли?
- Проверь права доступа к файлам

### 1.4 Permissions
- Проверь Info.plist на NSMicrophoneUsageDescription
- Проверь NSScreenCaptureUsageDescription если есть скриншоты
- Entitlements файл — корректны ли права?

**Формат вывода**: список находок с уровнем критичности (CRITICAL/HIGH/MEDIUM/LOW)

---

## Фаза 2: Архитектура (architecture)

Проанализируй архитектуру приложения:

### 2.1 MVVM паттерн
- Проверь разделение View/ViewModel/Model
- AppState — не слишком ли большой? (God Object?)
- Есть ли чёткие границы между слоями?

### 2.2 Сервисы
- Проверь сервисы в `Services/` директории
- Используются ли протоколы для абстракции?
- Можно ли тестировать сервисы изолированно?
- Delegate pattern реализован правильно?

### 2.3 Состояние
- Как управляется состояние записи?
- Есть ли state machine или enum для состояний?
- Проверь race conditions при async операциях

### 2.4 Зависимости
- Какие внешние зависимости используются?
- Управление зависимостями (SPM, CocoaPods)?
- Можно ли заменить зависимости моками?

**Формат вывода**: диаграмма зависимостей и список рекомендаций

---

## Фаза 3: Тестирование (tests)

Оцени состояние тестирования:

### 3.1 Текущее состояние
- Найди тесты в проекте (`*Tests.swift`, `*Spec.swift`)
- Есть ли test target в project.yml/xcodeproj?
- Какое покрытие кода?

### 3.2 Тестируемость
- Какие компоненты легко тестировать?
- TextCleanerService — чистые функции, идеально для тестов
- TranscriptEntry — модель данных
- StorageService — нужен mock UserDefaults

### 3.3 План тестирования
Если тестов нет, предложи план:
1. Какие тесты добавить первыми?
2. Как настроить test target?
3. Какие моки нужны?

**Формат вывода**: состояние тестов + план улучшения

---

## Фаза 4: Качество кода (quality)

Проверь качество кода:

### 4.1 Стиль и консистентность
- Единый стиль именования?
- Используется ли SwiftLint?
- Форматирование кода

### 4.2 Дублирование
- Поищи дублирующийся код
- Цвета темы — вынесены в Theme или дублируются?
- Magic numbers — есть ли константы?

### 4.3 Сложность
- Длинные методы (>50 строк)
- Длинные файлы (>300 строк)
- Глубокая вложенность

### 4.4 Потенциальные баги
- Force unwrap (`!`) без проверки
- Неиспользуемые переменные
- TODO/FIXME комментарии

**Формат вывода**: список проблем с приоритетом

---

## Фаза 5: macOS специфика (macos)

Проверь macOS-специфичные аспекты:

### 5.1 Menu Bar App
- LSUIElement в Info.plist (должно быть true для menu bar app)
- MenuBarExtra настройка
- Нет главного окна?

### 5.2 Entitlements
- Проверь Govorilka.entitlements
- Sandboxing включён?
- Какие capabilities запрошены?

### 5.3 Подготовка к публикации
- Code signing настроен?
- Готово к notarization?
- Есть ли версионирование (CFBundleVersion)?

**Формат вывода**: чеклист готовности к App Store / прямой дистрибуции

---

## Итоговый отчёт

После всех фаз выведи:

### Резюме
- Критические проблемы (требуют немедленного исправления)
- Высокий приоритет (исправить перед релизом)
- Средний приоритет (улучшения)
- Низкий приоритет (nice to have)

### Следующие шаги
Пронумерованный список конкретных действий для улучшения приложения.
